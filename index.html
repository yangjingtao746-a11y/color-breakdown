<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Color Breakdown · by JINTiao</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      --ui-accent:#5f9cff;
    }

    body{
      margin:0;
      color:#eaeaea;
      background:url("./bg.jpg") center/cover fixed no-repeat;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index:-1;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }

    .card{
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      border-radius:18px;
      padding:18px;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.18),
        0 12px 34px rgba(0,0,0,0.38);
      border:none;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; margin-bottom:14px; }
    .brand-name{ font-size:18px; font-weight:600; letter-spacing:0.3px; color:#fff; }
    .brand-sub{ font-size:11px; letter-spacing:0.8px; color:rgba(255,255,255,0.55); text-transform:lowercase; }
    .brand-by{ font-size:11px; letter-spacing:0.4px; color:rgba(255,255,255,0.35); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"]{ display:none; }

    .btn{
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, box-shadow .15s ease, transform .1s ease, border-color .15s ease, opacity .15s ease;
      border:none;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--ui-accent); box-shadow: 0 8px 18px rgba(95,156,255,0.18); }
    .btn-primary:hover{ background: rgba(95,156,255,0.92); }
    .btn-primary.soft{ background: rgba(95,156,255,0.82); box-shadow: 0 8px 18px rgba(95,156,255,0.12); }
    .btn-primary.soft:hover{ background: rgba(95,156,255,0.90); }

    .btn-ghost{
      background: rgba(95,156,255,0.10);
      color: #dbe6ff;
      border: 1px solid rgba(95,156,255,0.35);
      box-shadow: none;
    }
    .btn-ghost:hover{ background: rgba(95,156,255,0.16); border-color: rgba(95,156,255,0.50); }

    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
      box-shadow:none;
    }

    .upload-btn{ position:relative; overflow:hidden; }
    .upload-btn__hint{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; letter-spacing:0.5px;
      color: rgba(255,255,255,0.92);
      opacity:0; transform: translateY(6px);
      transition: opacity .16s ease, transform .16s ease;
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      pointer-events:none;
    }
    .upload-btn.dragover .upload-btn__hint{ opacity:1; transform: translateY(0); }
    .upload-btn::after{
      content:"";
      position:absolute;
      top:-60%; left:-120%;
      width:60%; height:220%;
      transform: rotate(20deg);
      pointer-events:none;
      background: linear-gradient(
        90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.16) 45%,
        rgba(255,255,255,0.26) 50%,
        rgba(255,255,255,0.16) 55%,
        rgba(255,255,255,0) 100%
      );
      opacity:0;
    }
    .upload-btn.dragover::after{ opacity:1; animation:sweep .85s ease-out forwards; }
    @keyframes sweep{ from{ left:-120%; } to{ left:160%; } }

    .btn.dragover{
      outline: 2px solid rgba(95,156,255,0.95);
      box-shadow: 0 0 0 6px rgba(95,156,255,0.18), inset 0 0 0 1px rgba(255,255,255,0.18);
    }

    .pill{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      color:#e9e9e9;
      padding:8px 12px;
      border-radius:999px;
      display:flex;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pill select{
      background:transparent;
      color:#eaeaea;
      border:none;
      outline:none;
      cursor:pointer;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:16px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .preview{
      width:100%;
      max-height:520px;
      object-fit:contain;
      border-radius:12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:block;
    }
    .preview.empty{ min-height:320px; }

    .chart-wrap{
      height: 420px;
      width: 100%;
      border-radius:12px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px;
      box-sizing: border-box;
    }
    #pie{
      width: 100% !important;
      height: 100% !important;
      display:block;
      background: transparent;
    }

    .list{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media (max-width:600px){ .list{ grid-template-columns:1fr; } }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      border-radius:12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .swatch{ width:18px; height:18px; border-radius:5px; border:1px solid rgba(255,255,255,0.32); }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; color: rgba(255,255,255,0.88); }
    .small{ font-size:12px; opacity:0.85; }
    .muted{ opacity:0.70; }
    .hr{ height:1px; background: rgba(255,255,255,0.12); margin:14px 0; }

    .exports{ display:none; gap:10px; align-items:center; flex-wrap:wrap; }
    .exports.show{ display:flex; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="brand">
      <div class="brand-name">Color Breakdown</div>
      <div class="brand-sub">color distribution analysis</div>
      <div class="brand-by">by JINTiao</div>
    </div>

    <div class="row">
      <button id="uploadBtn" class="btn btn-primary soft upload-btn" type="button">
        <span>录入</span>
        <span class="upload-btn__hint">松手即可录入</span>
      </button>
      <input id="file" type="file" accept="image/*" />

      <div class="pill">
        <span class="small muted">聚类颜色数</span>
        <select id="k"></select>
      </div>

      <div class="pill">
        <span class="small muted">抽样步长</span>
        <select id="step">
          <option value="1">1（最精确）</option>
          <option value="2" selected>2（推荐）</option>
          <option value="3">3</option>
          <option value="4">4（更快）</option>
        </select>
      </div>

      <div class="pill">
        <span class="small muted">模式</span>
        <select id="mode">
          <option value="color" selected>彩色</option>
          <option value="mono">无色相（灰阶）</option>
        </select>
      </div>

      <button id="run" class="btn btn-primary disabled" type="button">开始分析</button>

      <div id="exports" class="exports">
        <button id="exportPng" class="btn btn-ghost" type="button">导出PNG（透明底）</button>
        <button id="exportPieOnlyPng" class="btn btn-ghost" type="button">导出PNG（仅饼图透明底）</button>

        <button id="exportSvg" class="btn btn-ghost" type="button">导出SVG（透明底）</button>
        <button id="exportPieOnlySvg" class="btn btn-ghost" type="button">导出SVG（仅饼图透明底）</button>

        <button id="exportSwatchPng" class="btn btn-ghost" type="button">导出色卡PNG</button>
        <button id="exportSwatchSvg" class="btn btn-ghost" type="button">导出色卡SVG</button>
      </div>

      <span id="status" class="small muted"></span>
    </div>

    <div class="hr"></div>

    <div class="grid">
      <div>
        <img id="preview" class="preview empty" alt="预览" />
      </div>
      <div>
        <div class="chart-wrap">
          <canvas id="pie"></canvas>
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>

  </div>
</div>

<script>
  const fileEl = document.getElementById('file');
  const uploadBtn = document.getElementById('uploadBtn');
  const kEl = document.getElementById('k');
  const stepEl = document.getElementById('step');
  const modeEl = document.getElementById('mode');
  const runEl = document.getElementById('run');
  const statusEl = document.getElementById('status');
  const previewEl = document.getElementById('preview');
  const listEl = document.getElementById('list');
  const pieCanvas = document.getElementById('pie');
  const exportsWrap = document.getElementById('exports');

  const exportPngBtn = document.getElementById('exportPng');
  const exportPieOnlyPngBtn = document.getElementById('exportPieOnlyPng');
  const exportSvgBtn = document.getElementById('exportSvg');
  const exportPieOnlySvgBtn = document.getElementById('exportPieOnlySvg');

  const exportSwatchPngBtn = document.getElementById('exportSwatchPng');
  const exportSwatchSvgBtn = document.getElementById('exportSwatchSvg');

  const SIGN_TEXT = "Color Breakdown · JINTiao";

  let currentImage = null;
  let chart = null;

  let lastResult = null;
  let lastRender = null;

  (function initKOptions(){
    const frag = document.createDocumentFragment();
    for(let i=1;i<=15;i++){
      const op = document.createElement('option');
      op.textContent = String(i);
      if(i===4) op.selected = true;
      frag.appendChild(op);
    }
    kEl.appendChild(frag);
  })();

  function setStatus(msg){ statusEl.textContent = msg || ""; }
  function showExports(show){ exportsWrap.classList.toggle('show', !!show); }
  function enableRun(enable){ runEl.classList.toggle('disabled', !enable); }

  showExports(false);
  enableRun(false);

  uploadBtn.addEventListener('click', () => fileEl.click());

  function dist2(a,b){
    const dr=a[0]-b[0], dg=a[1]-b[1], db=a[2]-b[2];
    return dr*dr + dg*dg + db*db;
  }

  function rgbToHexStr(rgb){
    const to2 = (n)=> Math.max(0, Math.min(255, Math.round(n))).toString(16).padStart(2,'0');
    return ("#" + to2(rgb.r) + to2(rgb.g) + to2(rgb.b)).toUpperCase();
  }

  function rgbToCmyk(rgb){
    let r = rgb.r/255, g = rgb.g/255, b = rgb.b/255;
    const k = 1 - Math.max(r,g,b);
    let c=0,m=0,y=0;
    if(k < 1){
      c = (1 - r - k) / (1 - k);
      m = (1 - g - k) / (1 - k);
      y = (1 - b - k) / (1 - k);
    }
    const to100 = (v)=> Math.round(v*100);
    return { c:to100(c), m:to100(m), y:to100(y), k:to100(k) };
  }

  function initKMeansPP(pixels, k){
    const centers = [];
    const n = pixels.length;
    centers.push(pixels[Math.floor(Math.random()*n)].slice());
    while(centers.length < k){
      let total = 0;
      const d2 = new Array(n);
      for(let i=0;i<n;i++){
        let best = Infinity;
        for(let c=0;c<centers.length;c++){
          const d = dist2(pixels[i], centers[c]);
          if(d < best) best = d;
        }
        d2[i] = best;
        total += best;
      }
      if(total === 0){
        while(centers.length < k) centers.push(centers[0].slice());
        break;
      }
      let r = Math.random() * total;
      let pick = 0;
      for(let i=0;i<n;i++){
        r -= d2[i];
        if(r <= 0){ pick = i; break; }
      }
      centers.push(pixels[pick].slice());
    }
    return centers;
  }

  function kmeansRGB(pixels, k, maxIter=35){
    const n = pixels.length;
    let centers = initKMeansPP(pixels, k);
    let labels = new Array(n).fill(0);

    for(let iter=0; iter<maxIter; iter++){
      let changed = 0;

      for(let i=0;i<n;i++){
        let best=0, bestD=Infinity;
        const p = pixels[i];
        for(let c=0;c<k;c++){
          const d = dist2(p, centers[c]);
          if(d<bestD){ bestD=d; best=c; }
        }
        if(labels[i] !== best){ labels[i] = best; changed++; }
      }

      const sums = Array.from({length:k}, ()=>[0,0,0,0]);
      for(let i=0;i<n;i++){
        const lab = labels[i];
        const p = pixels[i];
        sums[lab][0]+=p[0]; sums[lab][1]+=p[1]; sums[lab][2]+=p[2]; sums[lab][3]+=1;
      }

      let moved = 0;
      for(let c=0;c<k;c++){
        if(sums[c][3]===0) continue;
        const newC = [sums[c][0]/sums[c][3], sums[c][1]/sums[c][3], sums[c][2]/sums[c][3]];
        moved += dist2(newC, centers[c]);
        centers[c] = newC;
      }

      if(changed===0 || moved < 1e-2) break;
    }

    const counts = Array.from({length:k}, ()=>0);
    for(const lab of labels) counts[lab]++;

    return { centers, counts };
  }

  function applyModeToColor(center, mode){
    const r = Math.round(center[0]);
    const g = Math.round(center[1]);
    const b = Math.round(center[2]);
    if(mode === "mono"){
      const l = Math.round(0.299*r + 0.587*g + 0.114*b);
      return { r:l, g:l, b:l };
    }
    return { r, g, b };
  }

  function renderFromResult(result){
    if(!result) return;

    const mode = modeEl.value;
    const total = result.counts.reduce((a,b)=>a+b,0);

    let items = result.centers.map((c,i)=>({
      center: c,
      count: result.counts[i],
      pct: result.counts[i] / total * 100
    }));

    items.sort((a,b)=> b.pct - a.pct);

    const rendered = items.map(it=>{
      const rgb = applyModeToColor(it.center, mode);
      const hex = rgbToHexStr(rgb);
      const cmyk = rgbToCmyk(rgb);
      return { rgb, hex, cmyk, pct: it.pct, count: it.count };
    });

    const showLegend = rendered.length <= 6;
    lastRender = { items: rendered, showLegend };

    const labels = rendered.map(it => it.hex);
    const colors = rendered.map(it=> `rgb(${it.rgb.r},${it.rgb.g},${it.rgb.b})`);
    const data = rendered.map(it=> Number(it.pct.toFixed(2)));

    if(chart) chart.destroy();

    // ✅ hover 外扩：电脑 10，手机 6（更稳）
    const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;

    chart = new Chart(pieCanvas.getContext('2d'), {
      type:'pie',
      data:{
        labels,
        datasets:[{
          data,
          backgroundColor: colors,

          // ✅ 关键：hover 不变色，只外扩
          hoverBackgroundColor: colors,
          hoverOffset: isCoarse ? 6 : 10,

          borderColor: "rgba(255,255,255,0.55)",
          hoverBorderColor: "rgba(255,255,255,0.55)",
          borderWidth: 1,
          hoverBorderWidth: 1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        rotation: -90 * Math.PI / 180,
        plugins:{
          legend:{
            display: showLegend,
            position:'bottom',
            labels:{
              color:'#eaeaea',
              boxWidth: 14,
              boxHeight: 10,
              padding: 10,
              font:{ size: 11 }
            }
          },
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.label}: ${ctx.parsed.toFixed(2)}%` } }
        }
      }
    });

    listEl.innerHTML = "";
    rendered.forEach((it)=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="swatch" style="background:${it.hex}"></div>
          <div>
            <div class="mono">${it.hex}</div>
            <div class="small muted">RGB(${it.rgb.r}, ${it.rgb.g}, ${it.rgb.b})</div>
            <div class="small muted">CMYK(${it.cmyk.c}, ${it.cmyk.m}, ${it.cmyk.y}, ${it.cmyk.k}) (approx.)</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700;">${it.pct.toFixed(2)}%</div>
          <div class="small muted">${it.count} px</div>
        </div>
      `;
      listEl.appendChild(div);
    });
  }

  modeEl.addEventListener('change', ()=>{
    if(lastResult) renderFromResult(lastResult);
  });

  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      currentImage = img;
      previewEl.src = url;
      previewEl.classList.remove('empty');
      setStatus(`已录入：${file.name}（${img.width}×${img.height}）`);
      enableRun(true);
      showExports(false);
      lastResult = null;
      lastRender = null;
    };
    img.onerror = () => setStatus("图片加载失败");
    img.src = url;
  }

  fileEl.addEventListener('change', (e)=> loadFile(e.target.files?.[0]));

  function analyze(){
    if(!currentImage){
      alert("请先录入一张图片（点击“录入”或拖拽到按钮上）");
      return;
    }

    const k = parseInt(kEl.value, 10);
    const step = parseInt(stepEl.value, 10);

    setStatus("分析中…");
    showExports(false);

    const c = document.createElement('canvas');
    const ctx = c.getContext('2d', { willReadFrequently:true });

    const maxSide = 1200;
    let w = currentImage.width, h = currentImage.height;
    const scale = Math.min(1, maxSide / Math.max(w,h));
    w = Math.max(1, Math.round(w*scale));
    h = Math.max(1, Math.round(h*scale));
    c.width = w; c.height = h;

    ctx.clearRect(0,0,w,h);
    ctx.drawImage(currentImage, 0, 0, w, h);

    const d = ctx.getImageData(0,0,w,h).data;

    const pixels = [];
    for(let y=0; y<h; y+=step){
      for(let x=0; x<w; x+=step){
        const i = (y*w + x) * 4;
        if(d[i+3] < 10) continue;
        pixels.push([d[i], d[i+1], d[i+2]]);
      }
    }

    if(pixels.length < k){
      setStatus("样本不足，无法聚类。");
      alert("样本点太少，无法完成聚类。请降低抽样步长或换更大的图。");
      return;
    }

    setTimeout(()=>{
      const result = kmeansRGB(pixels, k, 35);
      lastResult = result;
      renderFromResult(result);
      setStatus(`完成：${k} 色聚类（抽样步长 ${step}，样本 ${pixels.length}）`);
      showExports(true);
    }, 20);
  }

  runEl.addEventListener('click', analyze);

  // ===== PNG 导出（饼图截图）=====
  function exportChartPngWithSignature({ pieOnly }){
    if(!chart) return alert("请先分析图片生成饼图");

    const doExport = () => {
      const srcCanvas = chart.canvas;

      const out = document.createElement("canvas");
      out.width = srcCanvas.width;
      out.height = srcCanvas.height;
      const octx = out.getContext("2d");

      octx.drawImage(srcCanvas, 0, 0);

      const padding = 14;
      const fontSize = 12;
      octx.font = `${fontSize}px ui-monospace, Menlo, Consolas, monospace`;
      octx.textBaseline = "bottom";

      const metrics = octx.measureText(SIGN_TEXT);
      const x = out.width - padding - metrics.width;
      const y = out.height - padding;

      octx.save();
      octx.shadowColor = "rgba(0,0,0,0.35)";
      octx.shadowBlur = 4;
      octx.fillStyle = "rgba(255,255,255,0.28)";
      octx.fillText(SIGN_TEXT, x, y);
      octx.restore();

      const dataUrl = out.toDataURL("image/png");
      const filename = pieOnly
        ? "color-breakdown_jintiao_pie-only.png"
        : "color-breakdown_jintiao.png";

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    if(!pieOnly){
      doExport();
      return;
    }

    const prev = chart.options.plugins.legend.display;
    chart.options.plugins.legend.display = false;
    chart.update();

    requestAnimationFrame(()=>{
      doExport();
      chart.options.plugins.legend.display = prev;
      chart.update();
    });
  }

  exportPngBtn.addEventListener("click", ()=> exportChartPngWithSignature({ pieOnly:false }));
  exportPieOnlyPngBtn.addEventListener("click", ()=> exportChartPngWithSignature({ pieOnly:true }));

  // ===== SVG / 色卡导出部分：你原样保留（下面省略：与你发的代码一致）=====
  // ...（此处保持你原有的 buildPieSvg、exportSwatchPng、exportSwatchSvg、拖拽逻辑不变）
  // 由于你已贴了完整版本，我这里不重复粘贴后半段，避免你复制时出错。
  // 你只需要把上面 renderFromResult 的 Chart dataset 改成 hoverOffset 版本就能达成效果。

  // ===== 拖拽到按钮上传 =====
  function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }
  ["dragenter","dragover"].forEach(type=>{
    uploadBtn.addEventListener(type, (e)=>{
      preventDefaults(e);
      uploadBtn.classList.add("dragover");
    });
  });
  ["dragleave","dragend"].forEach(type=>{
    uploadBtn.addEventListener(type, (e)=>{
      preventDefaults(e);
      uploadBtn.classList.remove("dragover");
    });
  });
  uploadBtn.addEventListener("drop", (e)=>{
    preventDefaults(e);
    uploadBtn.classList.remove("dragover");
    const f = e.dataTransfer.files?.[0];
    if(f) loadFile(f);
  });
  window.addEventListener("dragover", (e)=> e.preventDefault());
  window.addEventListener("drop", (e)=> e.preventDefault());
</script>
</body>
</html>
