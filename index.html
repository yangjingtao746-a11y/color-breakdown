<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Color Breakdown · by JINTiao</title>

  <!-- Chart.js：主 CDN + 备用 CDN（避免你之前遇到 ERR_CONNECTION_CLOSED） -->
  <script>
    // 如果主 CDN 失败，就自动加载备用
    (function loadChartJs(){
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
      s.onerror = () => {
        const s2 = document.createElement('script');
        s2.src = "https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js";
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    })();
  </script>

  <style>
    :root{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      --ui-accent:#5f9cff;
    }

    body{
      margin:0;
      color:#eaeaea;
      background:url("./bg.jpg") center/cover fixed no-repeat;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index:-1;
    }

    .wrap{ max-width:1100px; margin:0 auto; padding:24px; }

    .card{
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      border-radius:18px;
      padding:18px;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.18),
        0 12px 34px rgba(0,0,0,0.38);
      border:none;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; margin-bottom:14px; }
    .brand-name{ font-size:18px; font-weight:600; letter-spacing:0.3px; color:#fff; }
    .brand-sub{ font-size:11px; letter-spacing:0.8px; color:rgba(255,255,255,0.55); text-transform:lowercase; }
    .brand-by{ font-size:11px; letter-spacing:0.4px; color:rgba(255,255,255,0.35); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"]{ display:none; }

    .btn{
      border-radius:10px;
      padding:10px 14px;
      font-weight:600;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, box-shadow .15s ease, transform .1s ease, border-color .15s ease, opacity .15s ease;
      border:none;
      color:#fff;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background: var(--ui-accent); box-shadow: 0 8px 18px rgba(95,156,255,0.18); }
    .btn-primary:hover{ background: rgba(95,156,255,0.92); }
    .btn-primary.soft{ background: rgba(95,156,255,0.82); box-shadow: 0 8px 18px rgba(95,156,255,0.12); }
    .btn-primary.soft:hover{ background: rgba(95,156,255,0.90); }

    .btn-ghost{
      background: rgba(95,156,255,0.10);
      color: #dbe6ff;
      border: 1px solid rgba(95,156,255,0.35);
      box-shadow: none;
    }
    .btn-ghost:hover{ background: rgba(95,156,255,0.16); border-color: rgba(95,156,255,0.50); }

    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
      box-shadow:none;
    }

    /* 录入按钮：拖拽提示层 + 扫光 */
    .upload-btn{ position:relative; overflow:hidden; }
    .upload-btn__hint{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; letter-spacing:0.5px;
      color: rgba(255,255,255,0.92);
      opacity:0; transform: translateY(6px);
      transition: opacity .16s ease, transform .16s ease;
      background: rgba(0,0,0,0.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      pointer-events:none;
    }
    .upload-btn.dragover .upload-btn__hint{ opacity:1; transform: translateY(0); }
    .upload-btn::after{
      content:"";
      position:absolute;
      top:-60%; left:-120%;
      width:60%; height:220%;
      transform: rotate(20deg);
      pointer-events:none;
      background: linear-gradient(
        90deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.16) 45%,
        rgba(255,255,255,0.26) 50%,
        rgba(255,255,255,0.16) 55%,
        rgba(255,255,255,0) 100%
      );
      opacity:0;
    }
    .upload-btn.dragover::after{ opacity:1; animation:sweep .85s ease-out forwards; }
    @keyframes sweep{ from{ left:-120%; } to{ left:160%; } }

    .btn.dragover{
      outline: 2px solid rgba(95,156,255,0.95);
      box-shadow: 0 0 0 6px rgba(95,156,255,0.18), inset 0 0 0 1px rgba(255,255,255,0.18);
    }

    .pill{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      color:#e9e9e9;
      padding:8px 12px;
      border-radius:999px;
      display:flex;
      gap:10px;
      align-items:center;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .pill select{
      background:transparent;
      color:#eaeaea;
      border:none;
      outline:none;
      cursor:pointer;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:16px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .preview{
      width:100%;
      max-height:520px;
      object-fit:contain;
      border-radius:12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.10);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:block;
    }
    .preview.empty{ min-height:320px; }

    .chart-wrap{
      height: 420px;
      width: 100%;
      border-radius:12px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 8px;
      box-sizing: border-box;
    }
    #pie{
      width: 100% !important;
      height: 100% !important;
      display:block;
      background: transparent;
    }

    .list{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media (max-width:600px){ .list{ grid-template-columns:1fr; } }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
      border-radius:12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .swatch{ width:18px; height:18px; border-radius:5px; border:1px solid rgba(255,255,255,0.32); }
    .mono{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; color: rgba(255,255,255,0.88); }
    .small{ font-size:12px; opacity:0.85; }
    .muted{ opacity:0.70; }
    .hr{ height:1px; background: rgba(255,255,255,0.12); margin:14px 0; }

    .exports{ display:none; gap:10px; align-items:center; flex-wrap:wrap; }
    .exports.show{ display:flex; }
    /* 预览区拖拽提示 */
    /* 预览区域外壳，用来承载提示文字 */
.preview-wrap{
  position: relative;
}

/* 拖拽提示文字 */
.preview-hint{
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  font-size: 14px;
  line-height: 1.6;
  color: rgba(255,255,255,0.55);
  pointer-events: none;
}

.preview-hint{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:14px;
  line-height:1.6;
  color:rgba(255,255,255,0.55);
  pointer-events:none;
}

  </style>
</head>

<body>
<div class="wrap">
  <div class="card">

    <div class="brand">
      <div class="brand-name">Color Breakdown</div>
      <div class="brand-sub">color distribution analysis</div>
      <div class="brand-by">by JINTiao</div>
    </div>

    <div class="row">
      <button id="uploadBtn" class="btn btn-primary soft upload-btn" type="button">
        <span>录入</span>
        <span class="upload-btn__hint">松手即可录入</span>
      </button>
      <input id="file" type="file" accept="image/*" />

      <div class="pill">
        <span class="small muted">聚类颜色数</span>
        <select id="k"></select>
      </div>

      <div class="pill">
        <span class="small muted">抽样步长</span>
        <select id="step">
          <option value="1">1（最精确）</option>
          <option value="2" selected>2（推荐）</option>
          <option value="3">3</option>
          <option value="4">4（更快）</option>
        </select>
      </div>

      <div class="pill">
        <span class="small muted">模式</span>
        <select id="mode">
          <option value="color" selected>彩色</option>
          <option value="mono">无色相（灰阶）</option>
        </select>
      </div>

      <div class="pill">
        <span class="small muted">吸色合并</span>
        <select id="mergeStrength">
          <option value="8">低（ΔE 8，更细）</option>
          <option value="12" selected>中（ΔE 12，推荐）</option>
          <option value="16">高（ΔE 16，更聚合）</option>
        </select>
      </div>

      <button id="run" class="btn btn-primary disabled" type="button">开始分析</button>
      <button id="pick" class="btn btn-primary disabled" type="button">开始吸色</button>

      <div id="exports" class="exports">
        <button id="exportPng" class="btn btn-ghost" type="button">导出PNG（透明底）</button>
        <button id="exportPieOnlyPng" class="btn btn-ghost" type="button">导出PNG（仅饼图透明底）</button>

        <button id="exportSvg" class="btn btn-ghost" type="button">导出SVG（透明底）</button>
        <button id="exportPieOnlySvg" class="btn btn-ghost" type="button">导出SVG（仅饼图透明底）</button>

        <button id="exportSwatchPng" class="btn btn-ghost" type="button">导出色卡PNG</button>
        <button id="exportSwatchSvg" class="btn btn-ghost" type="button">导出色卡SVG</button>
      </div>

      <span id="status" class="small muted"></span>
    </div>

    <div class="hr"></div>

   <div class="preview-hint" id="previewHint">
  拖拽图片到此处<br />
  或点击上方「录入」
</div>
<img id="preview" class="preview empty" alt="预览" />

      </div>
      <div>
        <div class="chart-wrap">
          <canvas id="pie"></canvas>
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>

  </div>
</div>

<script>
  // =========================
  // ✅ Pantone 全局变量（只声明一次！）
  // =========================
  let PANTONE_RAW = null;
  let PANTONE_LIST = [];     // 归一化后的数组：[{code,name,hex,rgb,lab}]
  let PANTONE_READY = false; // 是否可用
  const PANTONE_MATCH_CACHE = new Map(); // key: "#RRGGBB" -> match

  // =========================
  // DOM
  // =========================
  const fileEl = document.getElementById('file');
  const uploadBtn = document.getElementById('uploadBtn');
  const kEl = document.getElementById('k');
  const stepEl = document.getElementById('step');
  const modeEl = document.getElementById('mode');
  const mergeStrengthEl = document.getElementById('mergeStrength');
  const runEl = document.getElementById('run');
  const pickEl = document.getElementById('pick');
  const statusEl = document.getElementById('status');
  const previewEl = document.getElementById('preview');
  const listEl = document.getElementById('list');
  const pieCanvas = document.getElementById('pie');
  const exportsWrap = document.getElementById('exports');

  const exportPngBtn = document.getElementById('exportPng');
  const exportPieOnlyPngBtn = document.getElementById('exportPieOnlyPng');
  const exportSvgBtn = document.getElementById('exportSvg');
  const exportPieOnlySvgBtn = document.getElementById('exportPieOnlySvg');
  const exportSwatchPngBtn = document.getElementById('exportSwatchPng');
  const exportSwatchSvgBtn = document.getElementById('exportSwatchSvg');

  const SIGN_TEXT = "Color Breakdown · JINTiao";

  let currentImage = null;
  let chart = null;

  let lastResult = null;   // 普通分析结果
  let lastRender = null;   // 最终渲染/导出数据（分析或吸色）

  // =========================
  // 初始化：聚类颜色数 1 - 15
  // =========================
  (function initKOptions(){
    const frag = document.createDocumentFragment();
    for(let i=1;i<=15;i++){
      const op = document.createElement('option');
      op.textContent = String(i);
      if(i===4) op.selected = true;
      frag.appendChild(op);
    }
    kEl.appendChild(frag);
  })();

  function setStatus(msg){ statusEl.textContent = msg || ""; }
  function showExports(show){ exportsWrap.classList.toggle('show', !!show); }
  function enableRun(enable){ runEl.classList.toggle('disabled', !enable); }
  function enablePick(enable){ pickEl.classList.toggle('disabled', !enable); }

  showExports(false);
  enableRun(false);
  enablePick(false);

  uploadBtn.addEventListener('click', () => fileEl.click());

  // =========================
  // 基础工具
  // =========================
  function dist2(a,b){
    const dr=a[0]-b[0], dg=a[1]-b[1], db=a[2]-b[2];
    return dr*dr + dg*dg + db*db;
  }

  function clamp255(n){ return Math.max(0, Math.min(255, Math.round(n))); }

  function rgbToHexStr(rgb){
    const to2 = (n)=> clamp255(n).toString(16).padStart(2,'0');
    return ("#" + to2(rgb.r) + to2(rgb.g) + to2(rgb.b)).toUpperCase();
  }

  function hexToRgb(hex){
    if(!hex) return null;
    let h = String(hex).trim().replace(/^#/,'');
    if(h.length === 3) h = h.split('').map(ch=>ch+ch).join('');
    if(h.length !== 6) return null;
    const n = parseInt(h, 16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }

  function rgbToCmyk(rgb){
    let r = rgb.r/255, g = rgb.g/255, b = rgb.b/255;
    const k = 1 - Math.max(r,g,b);
    let c=0,m=0,y=0;
    if(k < 1){
      c = (1 - r - k) / (1 - k);
      m = (1 - g - k) / (1 - k);
      y = (1 - b - k) / (1 - k);
    }
    const to100 = (v)=> Math.round(v*100);
    return { c:to100(c), m:to100(m), y:to100(y), k:to100(k) };
  }

  // =========================
  // RGB -> Lab & ΔE
  // =========================
  function srgbToLinear(u){
    u = u / 255;
    return (u <= 0.04045) ? (u / 12.92) : Math.pow((u + 0.055) / 1.055, 2.4);
  }
  function rgbToXyz(rgb){
    const r = srgbToLinear(rgb.r);
    const g = srgbToLinear(rgb.g);
    const b = srgbToLinear(rgb.b);
    const x = r*0.4124564 + g*0.3575761 + b*0.1804375;
    const y = r*0.2126729 + g*0.7151522 + b*0.0721750;
    const z = r*0.0193339 + g*0.1191920 + b*0.9503041;
    return { x, y, z };
  }
  function xyzToLab(xyz){
    const Xn = 0.95047, Yn = 1.00000, Zn = 1.08883;
    let x = xyz.x / Xn;
    let y = xyz.y / Yn;
    let z = xyz.z / Zn;
    const f = (t)=> (t > 0.008856) ? Math.cbrt(t) : (7.787*t + 16/116);
    const fx = f(x), fy = f(y), fz = f(z);
    const L = 116*fy - 16;
    const a = 500*(fx - fy);
    const b = 200*(fy - fz);
    return { L, a, b };
  }
  function rgbToLab(rgb){ return xyzToLab(rgbToXyz(rgb)); }
  function deltaE76(l1, l2){
    const dL = l1.L - l2.L;
    const da = l1.a - l2.a;
    const db = l1.b - l2.b;
    return Math.sqrt(dL*dL + da*da + db*db);
  }

  // =========================
  // ✅ Pantone：归一化 + 匹配
  // pantone-numbers.json 结构（你截图里是 object）：
  // { "11-0103": { name:"egret", hex:"f3ece0" }, ... }
  // =========================
  function normalizePantoneDB(raw){
    const out = [];

    if(Array.isArray(raw)){
      // 兼容数组格式：[{code,name,hex}] 或类似
      for(const row of raw){
        const code = row.code || row.number || row.id || row.pantone || "";
        const name = row.name || row.label || "";
        const hex  = row.hex  || row.value || row.rgb || "";
        const rgb = hexToRgb(hex);
        if(!rgb) continue;
        out.push({ code:String(code), name:String(name), hex:rgbToHexStr(rgb), rgb, lab: rgbToLab(rgb) });
      }
      return out;
    }

    if(raw && typeof raw === "object"){
      // 你当前的格式：key -> {name,hex}
      const keys = Object.keys(raw);
      for(const code of keys){
        const v = raw[code];
        const name = (v && v.name != null) ? String(v.name) : "";
        const hex = (v && v.hex != null) ? String(v.hex) : "";
        const rgb = hexToRgb(hex);
        if(!rgb) continue;
        out.push({ code:String(code), name, hex:rgbToHexStr(rgb), rgb, lab: rgbToLab(rgb) });
      }
      return out;
    }

    return out;
  }

  function matchNearestPantone(rgb){
    if(!PANTONE_READY || !PANTONE_LIST.length) return null;

    const key = rgbToHexStr(rgb);
    if(PANTONE_MATCH_CACHE.has(key)) return PANTONE_MATCH_CACHE.get(key);

    const lab = rgbToLab(rgb);
    let best = null;
    let bestDE = Infinity;

    for(const p of PANTONE_LIST){
      const de = deltaE76(lab, p.lab);
      if(de < bestDE){
        bestDE = de;
        best = p;
        // 很接近就提前结束（加速）
        if(bestDE < 0.6) break;
      }
    }

    const res = best ? { code: best.code, name: best.name, hex: best.hex, de: bestDE } : null;
    PANTONE_MATCH_CACHE.set(key, res);
    return res;
  }

  // ✅ 加载 Pantone 数据（只在这里做一次）
  (function loadPantone(){
    fetch('./pantone-numbers.json')
      .then(res => {
        if(!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then(data => {
        PANTONE_RAW = data;
        PANTONE_LIST = normalizePantoneDB(data);
        PANTONE_READY = PANTONE_LIST.length > 0;
        console.log("Pantone normalized:", PANTONE_LIST.length);

        // 如果用户已经做过分析，Pantone 加载后自动刷新一次列表显示
        if(lastResult){
          renderFromResult(lastResult);
        }else if(lastRender && lastRender.items){
          renderFromRenderedItems(lastRender.items);
        }
      })
      .catch(err => {
        PANTONE_READY = false;
        PANTONE_LIST = [];
        console.warn("Pantone load failed:", err);
      });
  })();

  // =========================
  // K-means++
  // =========================
  function initKMeansPP(pixels, k){
    const centers = [];
    const n = pixels.length;
    centers.push(pixels[Math.floor(Math.random()*n)].slice());
    while(centers.length < k){
      let total = 0;
      const d2 = new Array(n);
      for(let i=0;i<n;i++){
        let best = Infinity;
        for(let c=0;c<centers.length;c++){
          const d = dist2(pixels[i], centers[c]);
          if(d < best) best = d;
        }
        d2[i] = best;
        total += best;
      }
      if(total === 0){
        while(centers.length < k) centers.push(centers[0].slice());
        break;
      }
      let r = Math.random() * total;
      let pick = 0;
      for(let i=0;i<n;i++){
        r -= d2[i];
        if(r <= 0){ pick = i; break; }
      }
      centers.push(pixels[pick].slice());
    }
    return centers;
  }

  function kmeansRGB(pixels, k, maxIter=35){
    const n = pixels.length;
    let centers = initKMeansPP(pixels, k);
    let labels = new Array(n).fill(0);

    for(let iter=0; iter<maxIter; iter++){
      let changed = 0;
      for(let i=0;i<n;i++){
        let best=0, bestD=Infinity;
        const p = pixels[i];
        for(let c=0;c<k;c++){
          const d = dist2(p, centers[c]);
          if(d<bestD){ bestD=d; best=c; }
        }
        if(labels[i] !== best){ labels[i] = best; changed++; }
      }

      const sums = Array.from({length:k}, ()=>[0,0,0,0]);
      for(let i=0;i<n;i++){
        const lab = labels[i];
        const p = pixels[i];
        sums[lab][0]+=p[0]; sums[lab][1]+=p[1]; sums[lab][2]+=p[2]; sums[lab][3]+=1;
      }

      let moved = 0;
      for(let c=0;c<k;c++){
        if(sums[c][3]===0) continue;
        const newC = [sums[c][0]/sums[c][3], sums[c][1]/sums[c][3], sums[c][2]/sums[c][3]];
        moved += dist2(newC, centers[c]);
        centers[c] = newC;
      }
      if(changed===0 || moved < 1e-2) break;
    }

    const counts = Array.from({length:k}, ()=>0);
    for(const lab of labels) counts[lab]++;
    return { centers, counts };
  }

  function applyModeToColor(center, mode){
    const r = Math.round(center[0]);
    const g = Math.round(center[1]);
    const b = Math.round(center[2]);
    if(mode === "mono"){
      const l = Math.round(0.299*r + 0.587*g + 0.114*b);
      return { r:l, g:l, b:l };
    }
    return { r, g, b };
  }

  function makeRenderedItemsFromKMeans(result, mode){
    const total = result.counts.reduce((a,b)=>a+b,0);
    let items = result.centers.map((c,i)=>({
      center: c,
      count: result.counts[i],
      pct: result.counts[i] / total * 100
    }));
    items.sort((a,b)=> b.pct - a.pct);

    return items.map(it=>{
      const rgb = applyModeToColor(it.center, mode);
      const hex = rgbToHexStr(rgb);
      const cmyk = rgbToCmyk(rgb);

      const pantone = matchNearestPantone(rgb); // ✅ Pantone 匹配
      return { rgb, hex, cmyk, pct: it.pct, count: it.count, pantone };
    });
  }

  // =========================
  // 相近合并：Lab ΔE
  // =========================
  function mergeSimilarByDeltaE(items, thresholdDE = 12){
    const sorted = items.slice().sort((a,b)=> b.pct - a.pct);

    const groups = [];
    for(const it of sorted){
      const lab = rgbToLab(it.rgb);

      let bestIdx = -1;
      let bestDE = Infinity;

      for(let gi=0; gi<groups.length; gi++){
        const de = deltaE76(lab, groups[gi].lab);
        if(de < bestDE){
          bestDE = de;
          bestIdx = gi;
        }
      }

      if(bestIdx !== -1 && bestDE <= thresholdDE){
        const g = groups[bestIdx];
        g.sumR += it.rgb.r * it.count;
        g.sumG += it.rgb.g * it.count;
        g.sumB += it.rgb.b * it.count;
        g.sumCount += it.count;
        g.sumPct += it.pct;

        const rgb = { r: g.sumR / g.sumCount, g: g.sumG / g.sumCount, b: g.sumB / g.sumCount };
        g.lab = rgbToLab(rgb);
      } else {
        groups.push({
          sumR: it.rgb.r * it.count,
          sumG: it.rgb.g * it.count,
          sumB: it.rgb.b * it.count,
          sumCount: it.count,
          sumPct: it.pct,
          lab
        });
      }
    }

    const merged = groups.map(g=>{
      const rgb = { r: Math.round(g.sumR / g.sumCount), g: Math.round(g.sumG / g.sumCount), b: Math.round(g.sumB / g.sumCount) };
      const hex = rgbToHexStr(rgb);
      const cmyk = rgbToCmyk(rgb);
      const pantone = matchNearestPantone(rgb);
      return { rgb, hex, cmyk, pct: g.sumPct, count: g.sumCount, pantone };
    });

    merged.sort((a,b)=> b.pct - a.pct);
    const sumPct = merged.reduce((s,x)=>s+x.pct,0) || 1;
    for(const m of merged) m.pct = (m.pct / sumPct) * 100;
    return merged;
  }

  // =========================
  // Render（统一入口）
  // =========================
  function renderFromRenderedItems(rendered){
    if(!rendered || !rendered.length) return;

    // 重新附加 pantone（确保 pantone 后加载也能刷新）
    const refreshed = rendered.map(it=>{
      const pantone = matchNearestPantone(it.rgb);
      return { ...it, pantone };
    });

    const showLegend = refreshed.length <= 6;
    lastRender = { items: refreshed, showLegend };

    const labels = refreshed.map(it => it.hex);
    const colors = refreshed.map(it=> `rgb(${it.rgb.r},${it.rgb.g},${it.rgb.b})`);
    const data = refreshed.map(it=> Number(it.pct.toFixed(2)));

    // 等 Chart.js 真正加载好（避免你那种网络失败导致的报错）
    if(typeof Chart === "undefined"){
      setStatus("Chart.js 未加载成功（请刷新或换网络）。");
      return;
    }

    if(chart) chart.destroy();
    chart = new Chart(pieCanvas.getContext('2d'), {
      type:'pie',
      data:{
        labels,
        datasets:[{
          data,
          backgroundColor: colors,
          borderWidth: 1,
          borderColor: "rgba(255,255,255,0.35)",
          hoverOffset: 8,
          hoverBackgroundColor: colors,
          hoverBorderColor: "rgba(255,255,255,0.35)",
          hoverBorderWidth: 1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        rotation: -90 * Math.PI / 180,
        plugins:{
          legend:{
            display: showLegend,
            position:'bottom',
            labels:{
              color:'#eaeaea',
              boxWidth: 14,
              boxHeight: 10,
              padding: 10,
              font:{ size: 11 }
            }
          },
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.label}: ${ctx.parsed.toFixed(2)}%` } }
        }
      }
    });

    // list
    listEl.innerHTML = "";
    refreshed.forEach((it)=>{
      const p = it.pantone;

      const pantoneLine = PANTONE_READY
        ? (p
            ? `<div class="small muted">Pantone：<span class="mono">${escapeHtml(p.code)}</span> · ${escapeHtml(p.name || "")} <span class="muted">（ΔE ${p.de.toFixed(2)}）</span></div>`
            : `<div class="small muted">Pantone：未匹配到</div>`
          )
        : `<div class="small muted">Pantone：未加载（检查 pantone-numbers.json）</div>`;

      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="swatch" style="background:${it.hex}"></div>
          <div>
            <div class="mono">${it.hex}</div>
            <div class="small muted">RGB(${it.rgb.r}, ${it.rgb.g}, ${it.rgb.b})</div>
            <div class="small muted">CMYK(${it.cmyk.c}, ${it.cmyk.m}, ${it.cmyk.y}, ${it.cmyk.k}) (approx.)</div>
            ${pantoneLine}
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:700;">${it.pct.toFixed(2)}%</div>
          <div class="small muted">${it.count} px</div>
        </div>
      `;
      listEl.appendChild(div);
    });
  }

  function renderFromResult(result){
    const mode = modeEl.value;
    const rendered = makeRenderedItemsFromKMeans(result, mode);
    renderFromRenderedItems(rendered);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  modeEl.addEventListener('change', ()=>{
    if(lastResult){
      renderFromResult(lastResult);
      setStatus(`模式切换：已更新显示（${modeEl.value === 'mono' ? '灰阶' : '彩色'}）`);
    } else if(lastRender){
      setStatus(`已切换模式：请重新点击“开始分析/开始吸色”以按新模式计算`);
    }
  });

  // =========================
  // 文件加载
  // =========================
  function loadFile(file){
    if(!file) return;
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      currentImage = img;
      previewEl.src = url;
      previewEl.classList.remove('empty');
      setStatus(`已录入：${file.name}（${img.width}×${img.height}）${PANTONE_READY ? " · Pantone OK" : " · Pantone loading..."}`);
      enableRun(true);
      enablePick(true);
      showExports(false);
      lastResult = null;
      lastRender = null;
    };
    img.onerror = () => setStatus("图片加载失败");
    img.src = url;
  }

  fileEl.addEventListener('change', (e)=> loadFile(e.target.files?.[0]));

  // =========================
  // 取样像素
  // =========================
  function getSampledPixelsFromImage(){
    const step = parseInt(stepEl.value, 10);
    const c = document.createElement('canvas');
    const ctx = c.getContext('2d', { willReadFrequently:true });

    const maxSide = 1200;
    let w = currentImage.width, h = currentImage.height;
    const scale = Math.min(1, maxSide / Math.max(w,h));
    w = Math.max(1, Math.round(w*scale));
    h = Math.max(1, Math.round(h*scale));
    c.width = w; c.height = h;

    ctx.clearRect(0,0,w,h);
    ctx.drawImage(currentImage, 0, 0, w, h);

    const d = ctx.getImageData(0,0,w,h).data;

    const pixels = [];
    for(let y=0; y<h; y+=step){
      for(let x=0; x<w; x+=step){
        const i = (y*w + x) * 4;
        if(d[i+3] < 10) continue;
        pixels.push([d[i], d[i+1], d[i+2]]);
      }
    }
    return { pixels, step };
  }

  // =========================
  // 分析
  // =========================
  function analyze(){
    if(!currentImage){
      alert("请先录入一张图片（点击“录入”或拖拽到按钮上）");
      return;
    }
    const k = parseInt(kEl.value, 10);

    setStatus("分析中…");
    showExports(false);

    const { pixels, step } = getSampledPixelsFromImage();
    if(pixels.length < k){
      setStatus("样本不足，无法聚类。");
      alert("样本点太少，无法完成聚类。请降低抽样步长或换更大的图。");
      return;
    }

    setTimeout(()=>{
      const result = kmeansRGB(pixels, k, 35);
      lastResult = result;
      renderFromResult(result);
      setStatus(`完成：${k} 色聚类（抽样步长 ${step}，样本 ${pixels.length}）${PANTONE_READY ? " · Pantone matched" : ""}`);
      showExports(true);
    }, 20);
  }

  // 吸色：固定 15 色 → ΔE 合并
  function pickColors(){
    if(!currentImage){
      alert("请先录入一张图片（点击“录入”或拖拽到按钮上）");
      return;
    }

    const K_PICK = 15;
    const mode = modeEl.value;
    const DE_TH = parseInt(mergeStrengthEl.value, 10) || 12;

    setStatus(`吸色中…（15色 → 相近合并：ΔE≤${DE_TH}）`);
    showExports(false);

    const { pixels, step } = getSampledPixelsFromImage();
    if(pixels.length < K_PICK){
      setStatus("样本不足，无法吸色。");
      alert("样本点太少，无法完成吸色。请降低抽样步长或换更大的图。");
      return;
    }

    setTimeout(()=>{
      const raw = kmeansRGB(pixels, K_PICK, 35);
      const rendered15 = makeRenderedItemsFromKMeans(raw, mode);
      const merged = mergeSimilarByDeltaE(rendered15, DE_TH);

      lastResult = null;
      renderFromRenderedItems(merged);

      setStatus(`吸色完成：15色 → 合并后 ${merged.length} 色（ΔE≤${DE_TH}，抽样步长 ${step}，样本 ${pixels.length}）${PANTONE_READY ? " · Pantone matched" : ""}`);
      showExports(true);
    }, 20);
  }

  runEl.addEventListener('click', analyze);
  pickEl.addEventListener('click', pickColors);

  // =========================
  // PNG 导出（饼图截图）
  // =========================
  function exportChartPngWithSignature({ pieOnly }){
    if(!chart) return alert("请先分析/吸色生成饼图");

    const doExport = () => {
      const srcCanvas = chart.canvas;

      const out = document.createElement("canvas");
      out.width = srcCanvas.width;
      out.height = srcCanvas.height;
      const octx = out.getContext("2d");

      // 透明底
      octx.drawImage(srcCanvas, 0, 0);

      // 右下角刻字
      const padding = 14;
      const fontSize = 12;
      octx.font = `${fontSize}px ui-monospace, Menlo, Consolas, monospace`;
      octx.textBaseline = "bottom";

      const metrics = octx.measureText(SIGN_TEXT);
      const x = out.width - padding - metrics.width;
      const y = out.height - padding;

      octx.save();
      octx.shadowColor = "rgba(0,0,0,0.35)";
      octx.shadowBlur = 4;
      octx.fillStyle = "rgba(255,255,255,0.28)";
      octx.fillText(SIGN_TEXT, x, y);
      octx.restore();

      const dataUrl = out.toDataURL("image/png");
      const filename = pieOnly
        ? "color-breakdown_jintiao_pie-only.png"
        : "color-breakdown_jintiao.png";

      const a = document.createElement("a");
      a.href = dataUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    if(!pieOnly){
      doExport();
      return;
    }

    const prev = chart.options.plugins.legend.display;
    chart.options.plugins.legend.display = false;
    chart.update();

    requestAnimationFrame(()=>{
      doExport();
      chart.options.plugins.legend.display = prev;
      chart.update();
    });
  }

  exportPngBtn.addEventListener("click", ()=> exportChartPngWithSignature({ pieOnly:false }));
  exportPieOnlyPngBtn.addEventListener("click", ()=> exportChartPngWithSignature({ pieOnly:true }));

  // =========================
  // SVG 导出（饼图矢量）
  // =========================
  function svgEscape(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }

  function polarToCartesian(cx, cy, r, angleRad){
    return { x: cx + r * Math.cos(angleRad), y: cy + r * Math.sin(angleRad) };
  }

  function wedgePath(cx, cy, r, startRad, endRad){
    const p1 = polarToCartesian(cx, cy, r, startRad);
    const p2 = polarToCartesian(cx, cy, r, endRad);
    const delta = endRad - startRad;
    const largeArc = (delta % (Math.PI*2)) > Math.PI ? 1 : 0;
    const sweep = 1;
    return [`M ${cx} ${cy}`, `L ${p1.x} ${p1.y}`, `A ${r} ${r} 0 ${largeArc} ${sweep} ${p2.x} ${p2.y}`, `Z`].join(" ");
  }

  function downloadSvg(svgText, filename){
    const blob = new Blob([svgText], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function buildPieSvg({ pieOnly }){
    if(!lastRender) return null;

    const items = lastRender.items;
    const showLegend = (!pieOnly) && lastRender.showLegend;

    const W = 1200;
    const H = showLegend ? 900 : 820;

    const cx = W/2;
    const cy = 420;
    const r  = 320;

    let start = -Math.PI/2;
    const paths = [];

    items.forEach((it)=>{
      const frac = it.pct / 100;
      const end = start + frac * Math.PI * 2;
      const fill = `rgb(${it.rgb.r},${it.rgb.g},${it.rgb.b})`;
      const d = wedgePath(cx, cy, r, start, end);
      paths.push(`<path d="${d}" fill="${fill}" stroke="rgba(255,255,255,0.35)" stroke-width="1"/>`);
      start = end;
    });

    let legend = "";
    if(showLegend){
      const box = 18;
      const gapX = 240;
      const startX = 150;
      const baseY = 780;

      legend += `<g font-family="system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, sans-serif" font-size="20" fill="rgba(255,255,255,0.92)">`;
      items.forEach((it, i)=>{
        const col = `rgb(${it.rgb.r},${it.rgb.g},${it.rgb.b})`;
        const x = startX + (i % 3) * gapX;
        const y = baseY + Math.floor(i / 3) * 44;
        legend += `
          <rect x="${x}" y="${y-18}" width="${box}" height="${box}" rx="4" fill="${col}" stroke="rgba(255,255,255,0.35)" />
          <text x="${x+box+10}" y="${y-2}">${svgEscape(it.hex)}</text>
        `;
      });
      legend += `</g>`;
    }

    const sigX = W - 40;
    const sigY = H - 26;

    return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <defs>
    <filter id="softShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.35)"/>
    </filter>
  </defs>
  <g>${paths.join("\n")}</g>
  ${legend}
  <text x="${sigX}" y="${sigY}" text-anchor="end"
        font-family="ui-monospace, Menlo, Consolas, monospace"
        font-size="20" fill="rgba(255,255,255,0.28)"
        filter="url(#softShadow)">${svgEscape(SIGN_TEXT)}</text>
</svg>`;
  }

  exportSvgBtn.addEventListener("click", ()=>{
    if(!lastRender) return alert("请先分析/吸色生成饼图");
    downloadSvg(buildPieSvg({ pieOnly:false }), "color-breakdown_jintiao.svg");
  });
  exportPieOnlySvgBtn.addEventListener("click", ()=>{
    if(!lastRender) return alert("请先分析/吸色生成饼图");
    downloadSvg(buildPieSvg({ pieOnly:true }), "color-breakdown_jintiao_pie-only.svg");
  });

  // =========================
  // 色卡导出（PNG + SVG）— ✅加入 Pantone 文案
  // =========================
  function buildSwatchLayout(n){
    const cols = Math.min(5, Math.max(1, n));
    const rows = Math.ceil(n / cols);
    return { cols, rows };
  }

  function exportSwatchPng(){
    if(!lastRender) return alert("请先分析/吸色得到颜色结果");
    const items = lastRender.items;
    const n = items.length;
    const { cols, rows } = buildSwatchLayout(n);

    const margin = 48;
    const gap = 26;
    const cardW = 210;
    const rectH = 140;
    const textH = 110;

    const W = margin*2 + cols*cardW + (cols-1)*gap;
    const H = margin*2 + rows*(rectH + textH) + (rows-1)*gap + 34;

    const c = document.createElement("canvas");
    c.width = W; c.height = H;
    const ctx = c.getContext("2d");

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,W,H);

    for(let i=0;i<n;i++){
      const it = items[i];
      const col = i % cols;
      const row = Math.floor(i / cols);

      const x = margin + col*(cardW + gap);
      const y = margin + row*(rectH + textH + gap);

      ctx.fillStyle = it.hex;
      ctx.fillRect(x, y, cardW, rectH);

      ctx.strokeStyle = "rgba(0,0,0,0.12)";
      ctx.lineWidth = 2;
      ctx.strokeRect(x, y, cardW, rectH);

      const tx = x;
      const ty = y + rectH + 18;

      ctx.fillStyle = "#111";
      ctx.font = "700 16px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText(it.hex, tx, ty);

      ctx.fillStyle = "rgba(0,0,0,0.72)";
      ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText(`RGB: ${it.rgb.r}, ${it.rgb.g}, ${it.rgb.b}`, tx, ty + 22);

      ctx.fillStyle = "rgba(0,0,0,0.65)";
      ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText(`CMYK: C${it.cmyk.c} M${it.cmyk.m} Y${it.cmyk.y} K${it.cmyk.k}`, tx, ty + 42);

      // Pantone 行
      const p = it.pantone;
      ctx.fillStyle = "rgba(0,0,0,0.60)";
      ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
      const pantoneText = (PANTONE_READY && p)
        ? `Pantone: ${p.code} · ${p.name || ""} (ΔE ${p.de.toFixed(2)})`
        : `Pantone: ${PANTONE_READY ? "N/A" : "Not loaded"}`;
      ctx.fillText(pantoneText.slice(0, 34), tx, ty + 62);

      ctx.fillStyle = "rgba(0,0,0,0.38)";
      ctx.font = "11px system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, sans-serif";
      ctx.fillText(`${it.pct.toFixed(2)}%`, tx, ty + 88);
    }

    ctx.textBaseline = "bottom";
    ctx.fillStyle = "rgba(0,0,0,0.30)";
    ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillText(SIGN_TEXT, W - margin, H - 16);

    const a = document.createElement("a");
    a.href = c.toDataURL("image/png");
    a.download = "color-breakdown_swatch_jintiao.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function exportSwatchSvg(){
    if(!lastRender) return alert("请先分析/吸色得到颜色结果");
    const items = lastRender.items;
    const n = items.length;
    const { cols, rows } = buildSwatchLayout(n);

    const margin = 48;
    const gap = 26;
    const cardW = 210;
    const rectH = 140;
    const textH = 110;

    const W = margin*2 + cols*cardW + (cols-1)*gap;
    const H = margin*2 + rows*(rectH + textH) + (rows-1)*gap + 34;

    let body = '';
    for(let i=0;i<n;i++){
      const it = items[i];
      const col = i % cols;
      const row = Math.floor(i / cols);

      const x = margin + col*(cardW + gap);
      const y = margin + row*(rectH + textH + gap);
      const tx = x;
      const ty = y + rectH + 18;

      const p = it.pantone;
      const pantoneText = (PANTONE_READY && p)
        ? `Pantone: ${p.code} · ${p.name || ""} (ΔE ${p.de.toFixed(2)})`
        : `Pantone: ${PANTONE_READY ? "N/A" : "Not loaded"}`;

      body += `
        <rect x="${x}" y="${y}" width="${cardW}" height="${rectH}" fill="${it.hex}" />
        <rect x="${x}" y="${y}" width="${cardW}" height="${rectH}" fill="none" stroke="rgba(0,0,0,0.12)" stroke-width="2" />

        <text x="${tx}" y="${ty}" font-family="ui-monospace, Menlo, Consolas, monospace" font-size="16" font-weight="700" fill="#111">${svgEscape(it.hex)}</text>
        <text x="${tx}" y="${ty+22}" font-family="ui-monospace, Menlo, Consolas, monospace" font-size="12" fill="rgba(0,0,0,0.72)">${svgEscape(`RGB: ${it.rgb.r}, ${it.rgb.g}, ${it.rgb.b}`)}</text>
        <text x="${tx}" y="${ty+42}" font-family="ui-monospace, Menlo, Consolas, monospace" font-size="12" fill="rgba(0,0,0,0.65)">${svgEscape(`CMYK: C${it.cmyk.c} M${it.cmyk.m} Y${it.cmyk.y} K${it.cmyk.k}`)}</text>
        <text x="${tx}" y="${ty+62}" font-family="ui-monospace, Menlo, Consolas, monospace" font-size="12" fill="rgba(0,0,0,0.60)">${svgEscape(pantoneText)}</text>

        <text x="${tx}" y="${ty+88}" font-family="system-ui, -apple-system, Segoe UI, Roboto, PingFang SC, Microsoft YaHei, sans-serif" font-size="11" fill="rgba(0,0,0,0.38)">${svgEscape(`${it.pct.toFixed(2)}%`)}</text>
      `;
    }

    const sigX = W - margin;
    const sigY = H - 16;

    downloadSvg(`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <rect x="0" y="0" width="${W}" height="${H}" fill="#ffffff" />
  ${body}
  <text x="${sigX}" y="${sigY}" text-anchor="end"
        font-family="ui-monospace, Menlo, Consolas, monospace"
        font-size="12" fill="rgba(0,0,0,0.30)">${svgEscape(SIGN_TEXT)}</text>
</svg>`, "color-breakdown_swatch_jintiao.svg");
  }

  exportSwatchPngBtn.addEventListener("click", exportSwatchPng);
  exportSwatchSvgBtn.addEventListener("click", exportSwatchSvg);

  // =========================
  // 拖拽到按钮上传
  // =========================
  function preventDefaults(e){ e.preventDefault(); e.stopPropagation(); }

  ["dragenter","dragover"].forEach(type=>{
    uploadBtn.addEventListener(type, (e)=>{
      preventDefaults(e);
      uploadBtn.classList.add("dragover");
    });
  });
  ["dragleave","dragend"].forEach(type=>{
    uploadBtn.addEventListener(type, (e)=>{
      preventDefaults(e);
      uploadBtn.classList.remove("dragover");
    });
  });
  uploadBtn.addEventListener("drop", (e)=>{
    preventDefaults(e);
    uploadBtn.classList.remove("dragover");
    const f = e.dataTransfer.files?.[0];
    if(f) loadFile(f);
  });

  window.addEventListener("dragover", (e)=> e.preventDefault());
  window.addEventListener("drop", (e)=> e.preventDefault());
</script>
</body>
</html>
