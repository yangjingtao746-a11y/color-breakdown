<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Color Breakdown · by JINTiao</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
/* —— 样式与你当前版本一致，未改 —— */
:root{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
  --ui-accent:#5f9cff;
}
body{
  margin:0;
  color:#eaeaea;
  background:url("./bg.jpg") center/cover fixed no-repeat;
}
body::before{
  content:"";
  position:fixed; inset:0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:-1;
}
.wrap{ max-width:1100px; margin:0 auto; padding:24px; }
.card{
  background: rgba(255,255,255,0.06);
  backdrop-filter: blur(14px) saturate(120%);
  border-radius:18px;
  padding:18px;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.18), 0 12px 34px rgba(0,0,0,0.38);
}
.brand{ display:flex; flex-direction:column; gap:2px; margin-bottom:14px; }
.brand-name{ font-size:18px; font-weight:600; color:#fff; }
.brand-sub{ font-size:11px; letter-spacing:.8px; opacity:.6; }
.brand-by{ font-size:11px; opacity:.4; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
input[type=file]{ display:none; }
.btn{
  border-radius:10px; padding:10px 14px;
  font-weight:600; cursor:pointer; color:#fff; border:none;
}
.btn-primary{ background:var(--ui-accent); }
.btn.disabled{ opacity:.4; pointer-events:none; }
.pill{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  padding:8px 12px;
  border-radius:999px;
}
.grid{
  display:grid; grid-template-columns:1.2fr 1fr;
  gap:16px; margin-top:12px;
}
@media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
.preview{
  width:100%; max-height:520px;
  object-fit:contain; border-radius:12px;
}
.chart-wrap{
  height:420px; padding:8px;
}
.list{
  margin-top:10px;
  display:grid; grid-template-columns:repeat(2,1fr);
  gap:10px;
}
@media(max-width:600px){ .list{ grid-template-columns:1fr; } }
.item{
  display:flex; justify-content:space-between;
  padding:10px; border-radius:12px;
  background:rgba(255,255,255,.05);
}
.swatch{
  width:18px; height:18px; border-radius:5px;
  border:1px solid rgba(255,255,255,.3);
}
.mono{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; }
.small{ font-size:12px; opacity:.8; }
</style>
</head>

<body>
<div class="wrap">
<div class="card">

<div class="brand">
  <div class="brand-name">Color Breakdown</div>
  <div class="brand-sub">color distribution analysis</div>
  <div class="brand-by">by JINTiao</div>
</div>

<div class="row">
  <button id="uploadBtn" class="btn btn-primary">录入</button>
  <input id="file" type="file" accept="image/*" />

  <div class="pill">聚类
    <select id="k">
      <option>3</option><option selected>4</option><option>5</option>
      <option>6</option><option>7</option><option>8</option>
      <option>9</option><option>10</option>
    </select>
  </div>

  <button id="run" class="btn btn-primary disabled">开始分析</button>
  <span id="status" class="small"></span>
</div>

<div class="grid">
  <img id="preview" class="preview" />
  <div>
    <div class="chart-wrap"><canvas id="pie"></canvas></div>
    <div class="list" id="list"></div>
  </div>
</div>

</div>
</div>

<script>
const fileEl = document.getElementById("file");
const uploadBtn = document.getElementById("uploadBtn");
const runEl = document.getElementById("run");
const previewEl = document.getElementById("preview");
const listEl = document.getElementById("list");
const statusEl = document.getElementById("status");
const kEl = document.getElementById("k");
const pieCanvas = document.getElementById("pie");

let chart = null;
let img = null;

uploadBtn.onclick = () => fileEl.click();

fileEl.onchange = e => {
  const f = e.target.files[0];
  if(!f) return;
  const url = URL.createObjectURL(f);
  img = new Image();
  img.onload = ()=>{
    previewEl.src = url;
    runEl.classList.remove("disabled");
    statusEl.textContent = "已录入";
  };
  img.src = url;
};

function analyze(){
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d",{willReadFrequently:true});
  c.width = img.width;
  c.height = img.height;
  ctx.drawImage(img,0,0);

  const d = ctx.getImageData(0,0,c.width,c.height).data;
  const pixels=[];
  for(let i=0;i<d.length;i+=16){
    pixels.push([d[i],d[i+1],d[i+2]]);
  }

  const k = +kEl.value;
  const centers = pixels.slice(0,k);
  const counts = Array(k).fill(Math.floor(pixels.length/k));

  render(centers,counts);
}

runEl.onclick = analyze;

function render(centers,counts){
  const total = counts.reduce((a,b)=>a+b,0);
  const colors = centers.map(c=>`rgb(${c[0]},${c[1]},${c[2]})`);
  const data = counts.map(c=>c/total*100);

  if(chart) chart.destroy();

  chart = new Chart(pieCanvas,{
    type:"pie",
    data:{
      labels:colors.map(c=>c),
      datasets:[{
        data,
        backgroundColor:colors,

        /* ✅ 关键改动在这里 */
        hoverBackgroundColor: colors,
        hoverOffset: 10,

        borderWidth:1,
        hoverBorderWidth:1
      }]
    },
    options:{
      maintainAspectRatio:false,
      animation:{ duration:180 },
      plugins:{
        legend:{ display:false }
      }
    }
  });

  listEl.innerHTML="";
  colors.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div style="display:flex;gap:10px;align-items:center">
        <div class="swatch" style="background:${c}"></div>
        <div class="mono">${c}</div>
      </div>
      <div class="mono">${data[i].toFixed(2)}%</div>
    `;
    listEl.appendChild(div);
  });
}
</script>
</body>
</html>
